# Use the official .NET 8 SDK image as the build environment
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build-env

# Needed for Native AOT compilation
RUN apt update
RUN apt install -y clang zlib1g-dev

# Set the working directory
WORKDIR /app

# Copy just files needed for dotnet restore
COPY *.sln ./
COPY src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj ./src/PwrDrvr.LambdaDispatch.LambdaLB/
COPY src/PwrDrvr.LambdaDispatch.Messages/PwrDrvr.LambdaDispatch.Messages.csproj ./src/PwrDrvr.LambdaDispatch.Messages/

# Restore dependencies
RUN dotnet restore src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj

# Copy everything from the current directory to the working directory in the image
COPY . ./

# Build the project
RUN dotnet publish src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj -c Release --self-contained true --runtime linux-arm64 -o out

# Use the Amazon Linux 2023 image as the runtime environment
FROM amazonlinux:2023

# Set the working directory
WORKDIR /app

# Install the ICU libraries
RUN yum install -y libicu

# Copy the build output from the build environment
COPY --from=build-env /app/out .
COPY --from=build-env /app/certs/*.pfx ./certs/

# Set the entrypoint
ENTRYPOINT ["./bootstrap"]