# Use the official .NET 8 SDK image as the build environment
# Build with whatever CPU the host OS has
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build-env

# Needed for Native AOT compilation
RUN apt update
RUN apt install -y clang zlib1g-dev

# Set the working directory
WORKDIR /app

# Copy just files needed for dotnet restore
COPY *.sln ./
COPY src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj ./src/PwrDrvr.LambdaDispatch.LambdaLB/
COPY src/PwrDrvr.LambdaDispatch.Messages/PwrDrvr.LambdaDispatch.Messages.csproj ./src/PwrDrvr.LambdaDispatch.Messages/

# Restore dependencies
RUN dotnet restore src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj

# Copy everything from the current directory to the working directory in the image
COPY . ./

# Build the project
RUN dotnet publish src/PwrDrvr.LambdaDispatch.LambdaLB/PwrDrvr.LambdaDispatch.LambdaLB.csproj -c Release --self-contained true --runtime linux-arm64 -o out /p:NativeAot=true

# We do not need the ~40 MB of ICU libs
RUN rm out/libicu*


#
# Build the node.js app
#
# Build with whatever CPU the host OS has
FROM node:20-alpine AS node-build-env

# Set the working directory
WORKDIR /app

# Copy just files needed for npm install
COPY src/demo-app/package.json src/demo-app/package-lock.json ./

# Install dependencies
RUN npm install

# Copy everything from the current directory to the working directory in the image
COPY src/demo-app/ ./

# Build the app
RUN npm run build


#
# Use the Amazon Linux 2023 image as the runtime environment
#
# Use the runtime image for ARM64
# FROM amazonlinux:2023
FROM --platform=linux/arm64 public.ecr.aws/lambda/provided:al2023

# Set the working directory
WORKDIR /app

RUN dnf install -y nodejs

# Copy the build output from the build environment
# This is a self-contained single binary file
COPY --from=build-env /app/out/bootstrap .

# Copy the node.js app
COPY --from=node-build-env /app/dist/ dist/
COPY --from=node-build-env /app/startapp.sh ./

# Set the entrypoint
ENTRYPOINT ["./bootstrap"]